language: go
go:
  - 1.6

sudo: false

before_install:
  - nvm install stable
  - nvm use stable
  - export CHROME_BIN=chromium-browser  # Karma CI
  - export DISPLAY=:99.0

install:
 - npm install
 - go get -t -v ./...

before_script:
  - sh -e /etc/init.d/xvfb start
  - npm run webdriver-update
  - nohup npm run webdriver-start 2>&1 &
  #- sleep 1  # give server time to start

script:
  - go test -v -cover ./src/backend/omni-tempore-backend/...
  - npm test
  - npm run build.prod
  - go install ./...
  ## start backend
  - nohup npm run start.backend > start.backend.out 2>&1 &
  - nohup npm run serve.e2e > serve.e2e.out 2>&1 &
  - sleep 15 # give server time to start
  - npm run e2e


after_failure:
  - cat serve.e2e.out
  - cat start.backend.out
  - cat npm-debug.log

notifications:
  email: true

env:
  global:
    # https://github.com/DefinitelyTyped/tsd#tsdrc
    # Token has no scope (read-only access to public information)
    - TSD_GITHUB_TOKEN=19937e314622fdaf0f26aa9b6738de2642b7a6f9

cache:
  directories: node_modules
